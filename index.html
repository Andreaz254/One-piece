<script>
  async function setupBraintree() {
    try {
      const response = await fetch("/api/generate_token");
      const data = await response.json();

      if (!data.clientToken) {
        console.error("No client token received:", data);
        alert("Failed to connect to payment server. Please try again later.");
        return;
      }

      braintree.dropin.create({
        authorization: data.clientToken,
        container: "#dropin-container",
      }, function (createErr, instance) {
        if (createErr) {
          console.error("Braintree setup error:", createErr);
          alert("Error setting up payment form. Check console.");
          return;
        }

        const button = document.getElementById("submit-button");
        button.addEventListener("click", async () => {
          instance.requestPaymentMethod(async (err, payload) => {
            if (err) {
              console.error("Payment method error:", err);
              alert("Payment error. Please check your details.");
              return;
            }

            console.log("Payment Nonce:", payload.nonce);
            alert("Processing your payment...");

            // ✅ Send nonce + amount to your backend
            try {
              const checkoutResponse = await fetch("https://handling-impacts-soma-baby.trycloudflare.com/process_payment", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  nonce: payload.nonce,
                  amount: 29.99,
                  product_id: "DIGI-CIRCUIT-EBOOK-001"
                }),
              });

              const result = await checkoutResponse.json();

              if (checkoutResponse.ok && result.success) {
                alert(`✅ Payment successful! Transaction ID: ${result.transaction_id}`);
                // Optionally redirect or show download link here
              } else {
                alert(`❌ Payment failed: ${result.error || "Unknown error"}`);
              }
            } catch (sendErr) {
              console.error("Error sending nonce:", sendErr);
              alert("Could not connect to payment server. Please try again later.");
            }
          });
        });
      });
    } catch (error) {
      console.error("Error setting up Braintree:", error);
      alert("Setup failed — check console for details.");
    }
  }

  setupBraintree();
</script>
